# 单次任务功能说明

## 功能概述

定时任务现在支持**单次执行**模式，就像日历事件一样，可以指定具体的日期和时间，只执行一次。

## 调度类型

现在支持4种调度类型：

| 类型 | 说明 | 示例 |
|------|------|------|
| **daily** | 每天 | 每天 09:00 |
| **weekly** | 每周 | 每周 09:00 |
| **weekday** | 特定星期 | 每周一 09:00 |
| **once** | 单次 | 2026-03-15 09:00（只执行一次） |

## 单次任务使用方法

### 创建单次任务

1. 点击"添加任务"
2. 选择调度类型：**once（单次）**
3. 设置日期：
   - 年：2024-2030
   - 月：1-12
   - 日：1-31
4. 设置时间：小时和分钟
5. 设置接收者和消息内容
6. 点击"保存"

### 示例场景

#### 示例1: 生日提醒
```
任务名称：张三生日提醒
调度类型：once（单次）
日期：2026-03-15
时间：09:00
接收者：张三
消息：生日快乐！🎂
```

#### 示例2: 会议提醒
```
任务名称：项目会议提醒
调度类型：once（单次）
日期：2026-02-10
时间：14:30
接收者：项目组, 李四, 王五
消息：下午3点项目会议，请准时参加
```

#### 示例3: 纪念日提醒
```
任务名称：结婚纪念日
调度类型：once（单次）
日期：2026-05-20
时间：10:00
接收者：老婆
消息：结婚纪念日快乐！❤️
```

## 单次任务特性

### 1. 自动禁用
- 单次任务执行后会**自动禁用**
- 状态变为"禁用"
- 下次运行显示为"已完成"

### 2. 日期验证
- 不能设置过去的日期
- 自动验证日期有效性（如2月30日会报错）
- 年份范围：2024-2030

### 3. 任务列表显示
- 类型列显示：`单次(2026-03-15)`
- 包含具体日期，一目了然
- 执行后显示"已完成"

### 4. 精确调度
- 使用秒级精度计算
- 确保在指定时间准确执行
- 不会重复执行

## 与其他类型的对比

| 特性 | 每天/每周/特定星期 | 单次 |
|------|-------------------|------|
| 重复执行 | ✅ 是 | ❌ 否 |
| 需要日期 | ❌ 否 | ✅ 是 |
| 自动禁用 | ❌ 否 | ✅ 是 |
| 适用场景 | 日常提醒 | 特定事件 |

## 使用建议

### 推荐场景

1. **生日提醒** - 每年的生日可以创建单次任务
2. **会议提醒** - 一次性会议
3. **纪念日** - 特殊日子的提醒
4. **临时事件** - 任何一次性的提醒需求
5. **倒计时提醒** - 重要日期前的提醒

### 最佳实践

1. **提前设置**
   - 建议提前几天设置，避免遗忘
   - 可以设置多个提醒（如提前1天、提前1小时）

2. **清晰命名**
   - 任务名称包含日期和事件
   - 例如："2026-03-15 张三生日"

3. **定期清理**
   - 已完成的单次任务可以删除
   - 或者保留作为历史记录

4. **多接收者**
   - 可以同时提醒多个人
   - 例如：会议提醒发给所有参会者

### 不推荐场景

1. ❌ 需要重复的提醒（使用每天/每周/特定星期）
2. ❌ 长期的日常任务（使用其他类型）

## 技术细节

### 数据结构

单次任务的数据结构：
```json
{
  "id": "task_001",
  "name": "生日提醒",
  "schedule_type": "once",
  "date": "2026-03-15",
  "time": "09:00",
  "recipient": "张三",
  "message": "生日快乐！",
  "enabled": true,
  "next_run": "2026-03-15 09:00:00"
}
```

### 执行逻辑

1. **调度时**：
   - 计算距离目标时间的秒数
   - 使用 `schedule.every(N).seconds` 注册
   - 只执行一次

2. **执行后**：
   - 发送消息到队列
   - 设置 `enabled = false`
   - 设置 `next_run = None`
   - 保存任务状态

3. **重启后**：
   - 重新计算是否需要执行
   - 如果时间已过，跳过调度
   - 如果时间未到，重新注册

### 时间计算

```python
# 计算目标时间
target_datetime = datetime(year, month, day, hour, minute, 0)

# 计算距离现在的秒数
seconds_until = (target_datetime - now).total_seconds()

# 注册单次执行
schedule.every(int(seconds_until)).seconds.do(execute_task, task=task)
```

## 常见问题

### Q: 单次任务执行后还能再次启用吗？

**A:** 可以，但需要修改日期：
1. 编辑任务
2. 修改日期为未来的日期
3. 保存后会自动启用

### Q: 如果设置的时间已经过了怎么办？

**A:**
- 创建时会提示"日期不能是过去的日期"
- 如果服务重启时发现时间已过，会跳过调度
- 建议删除或修改日期

### Q: 单次任务可以设置多个接收者吗？

**A:** 可以！和其他类型一样支持多接收者：
- 用逗号分隔：`张三, 李四, 王五`
- 或从列表双击添加

### Q: 单次任务会重复执行吗？

**A:** 不会！单次任务的特点就是：
- 只执行一次
- 执行后自动禁用
- 不会重复

### Q: 如何查看已完成的单次任务？

**A:**
- 在任务列表中，状态显示为"禁用"
- 下次运行显示为"已完成"
- 可以保留或删除

### Q: 单次任务支持@功能吗？

**A:** 支持！如果是群聊消息：
- 勾选"群聊消息"
- 设置@列表
- 和其他类型完全一样

## 更新日志

**2026-02-03:**
- ✅ 添加单次任务模式（once）
- ✅ 添加日期选择器（年、月、日）
- ✅ 自动禁用已执行的单次任务
- ✅ 日期验证（不能是过去的日期）
- ✅ 任务列表显示日期信息
- ✅ 支持精确的秒级调度

---

**提示：** 单次任务非常适合特殊事件提醒，配合多接收者功能使用效果更佳！
