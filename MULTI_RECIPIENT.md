# 定时任务多接收者功能说明

## 功能概述

定时任务现在支持同时向多个接收者发送消息。

## 使用方法

### 方法1: 手动输入（推荐）

在"接收者"输入框中，直接输入多个接收者，用**逗号**分隔：

```
好友A, 群B, 好友C
```

### 方法2: 从列表选择

1. 在"可选列表"中找到要添加的接收者
2. **双击**该接收者
3. 接收者会自动添加到上方的输入框中
4. 重复步骤1-3添加更多接收者

### 方法3: 混合使用

- 可以先从列表双击添加几个
- 然后手动编辑输入框，添加或删除接收者
- 使用"清空"按钮可以一键清空所有接收者

## 示例

### 示例1: 每天早上向多个群发送消息

**任务设置：**
- 任务名称：每日早安
- 调度类型：每天
- 时间：08:00
- 接收者：`工作群, 朋友群, 家人群`
- 消息内容：早安！新的一天开始了~

**效果：**
- 每天早上8点
- 同时向"工作群"、"朋友群"、"家人群"发送消息
- 消息会按照2秒间隔依次发送

### 示例2: 每周一向多个好友发送提醒

**任务设置：**
- 任务名称：周一提醒
- 调度类型：特定星期 - 周一
- 时间：09:00
- 接收者：`张三, 李四, 王五`
- 消息内容：周一快乐！记得开会~

**效果：**
- 每周一早上9点
- 向张三、李四、王五三个人分别发送消息

## 注意事项

### 1. 接收者名称必须准确

- 接收者名称必须与微信中的名称**完全一致**
- 区分大小写
- 建议从"可选列表"中双击选择，避免输入错误

### 2. 发送间隔

- 多个接收者的消息会依次发送
- 每条消息之间有**2秒间隔**
- 例如：3个接收者需要约6秒完成发送

### 3. 群聊和私聊

- 可以混合群聊和私聊接收者
- 如果勾选"群聊消息"，所有接收者都会被当作群聊处理
- 如果不勾选，所有接收者都会被当作私聊处理
- **建议：** 群聊和私聊分开创建不同的任务

### 4. @功能

- 如果勾选"群聊消息"并设置了@列表
- @列表会应用到**所有**群聊接收者
- 例如：@列表设置为"张三"，则所有群都会@张三

## 最佳实践

### 推荐做法

1. **分类创建任务**
   - 群聊任务和私聊任务分开
   - 相同类型的接收者放在一起

2. **使用清晰的任务名称**
   - 例如："每日早安-工作群组"
   - 例如："周报提醒-项目成员"

3. **从列表选择**
   - 优先使用双击选择，避免输入错误
   - 选择后可以手动调整顺序

### 不推荐做法

1. ❌ 混合群聊和私聊在同一个任务中
2. ❌ 接收者过多（建议不超过10个）
3. ❌ 手动输入容易拼错的名称

## 技术细节

### 数据存储

接收者以逗号分隔的字符串形式存储：
```json
{
  "recipient": "好友A, 群B, 好友C"
}
```

### 执行逻辑

1. 任务触发时，解析接收者字符串
2. 分割成接收者列表
3. 为每个接收者创建一条消息
4. 依次添加到消息队列
5. 消息队列按2秒间隔发送

### 监听列表

- 所有接收者会自动添加到监听列表
- 启动服务时自动去重
- 确保能接收到发送后的回调

## 常见问题

### Q: 为什么有些接收者没有收到消息？

**A:** 可能的原因：
1. 接收者名称输入错误（检查大小写、空格）
2. 接收者不在监听列表中（会自动添加，但需要重启服务）
3. 微信连接问题

**解决方案：**
- 使用双击选择而不是手动输入
- 重启服务确保监听列表更新
- 查看日志确认发送状态

### Q: 可以向多少个接收者发送？

**A:** 理论上没有限制，但建议：
- 不超过10个接收者
- 如果接收者太多，考虑分成多个任务
- 注意发送间隔（2秒/条）

### Q: 群聊和私聊可以混合吗？

**A:** 技术上可以，但不推荐：
- 群聊和私聊的消息格式不同
- @功能只对群聊有效
- 建议分开创建任务

### Q: 如何修改已有任务的接收者？

**A:**
1. 在定时任务列表中选择任务
2. 点击"编辑任务"
3. 修改接收者列表
4. 点击"保存"

## 更新日志

**2026-02-03:**
- ✅ 添加多接收者支持
- ✅ 添加可选列表双击选择
- ✅ 添加清空按钮
- ✅ 自动去重接收者
- ✅ 优化任务执行逻辑

---

**提示：** 如果遇到问题，请查看日志获取详细信息。
